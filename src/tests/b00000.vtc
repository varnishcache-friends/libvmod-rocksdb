varnishtest "Test rocksdb operations"

server s1 {
	rxreq
	txresp
} -start

varnish v1 -vcl+backend {
	import rocksdb from "${vmod_topbuild}/src/.libs/libvmod_rocksdb.so";

	sub vcl_init {
		new db = rocksdb.rocksdb("${tmpdir}/rocksdb", true);
	}

	sub vcl_deliver {
		set resp.http.foo0 = db.get("foo");
		db.put("foo", "bar");
		set resp.http.foo1 = db.get("foo");
		db.delete("foo");
		set resp.http.foo2 = db.get("foo");
	}
} -start

client c1 {
	txreq
	rxresp
	expect resp.http.foo0 == ""
	expect resp.http.foo1 == "bar"
	expect resp.http.foo2 == ""
} -run
